<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.learn.board.impl.BoardDAO">


	<insert id="insertQnaBoard" parameterType="board">
		INSERT INTO QUESTION_BOARD
		 (QBOARD_NO,LECTURE_NO,USER_ID,GRADE,CATEGORY_NAME,BOARD_TITLE,BOARD_CONTENT,BOARD_FILE)
		VALUES ((SELECT NVL(MAX(QBOARD_NO),0) + 1 FROM QUESTION_BOARD), #{lectureNo},
		 #{userId}, #{grade}, #{categoryName}, #{boardTitle}, #{boardContent}, #{boardFile})
	</insert>
	
	
	
	
	<insert id="insertFreeBoard" parameterType="board">
		INSERT INTO FREE_BOARD
		 (FBOARD_NO,USER_ID,GRADE,BOARD_TITLE,BOARD_CONTENT,BOARD_FILE)
		VALUES ((SELECT NVL(MAX(FBOARD_NO),0) + 1 FROM FREE_BOARD),
		 #{userId}, #{grade}, #{boardTitle}, #{boardContent}, #{boardFile})
	</insert>
	
	
	
	
	<select id="countQnaBoard" parameterType="board" resultType="int">
		SELECT COUNT(QBOARD_NO) FROM QUESTION_BOARD
		WHERE 1 = 1
		<if test="searchKeyword != null">		
		AND (USER_ID LIKE '%'|| #{searchKeyword} ||'%'
		OR BOARD_TITLE LIKE '%'|| #{searchKeyword} ||'%'
		OR BOARD_CONTENT LIKE '%'|| #{searchKeyword} ||'%')		
		</if>			
		<if test="boardAdopt != 'all'">
		AND BOARD_ADOPT = #{boardAdopt}
		</if>	
	</select>
	
	
	<select id="getQnaBoardList" parameterType="map" resultType="board">
		SELECT * FROM
			(SELECT ROWNUM R_NUM, B.* from 
				(SELECT * FROM QUESTION_BOARD 
					WHERE 1 = 1	
					<if test="searchKeyword != null">
					AND (
					USER_ID LIKE '%'|| #{searchKeyword} ||'%'
					OR BOARD_TITLE LIKE '%'|| #{searchKeyword} ||'%'
					OR BOARD_CONTENT LIKE '%'|| #{searchKeyword} ||'%')
					</if>		
					<if test="boardAdopt != 'all'">
					AND BOARD_ADOPT = #{boardAdopt}
					</if>		
					ORDER BY ${ordering} DESC) B)					
		WHERE R_NUM BETWEEN #{begin} AND #{end}
	</select>
	
	
	<update id="updateBoard" parameterType="board">
		<if test="qboardNo != null">
		UPDATE QUESTION_BOARD
		 SET BOARD_TITLE = #{boardTitle}, BOARD_CONTENT = #{boardContent}, BOARD_FILE = #{boardFile},
		  BOARD_ADOPT = #{boardAdopt}, BOARD_HIT = #{boardHit}, BOARD_LIKE = #{boardLike}, COMMENT_CNT = #{commentCnt}
		 WHERE QBOARD_NO = #{qboardNo}
		</if>
	</update>
	
	
	<select id="getQnaLike" parameterType="map" resultType="qnaLike">
		SELECT * FROM QNA_LIKE
		WHERE USER_ID = #{userId}
		AND BOARD_NO = #{boardNo}
	</select>
	
	<insert id="insertQnaLike" parameterType="map">
		INSERT INTO QNA_LIKE
		(USER_ID, BOARD_NO)
		VALUES (#{userId}, #{boardNo})
	</insert>
	
	<delete id="deleteQnaLike" parameterType="map">
		DELETE FROM QNA_LIKE
		WHERE USER_ID = #{userId}
		AND BOARD_NO = #{boardNo}
	</delete>
	
	
	<delete id="deleteBoard" parameterType="board">
		<if test="qboardNo != null">
			DELETE FROM QUESTION_BOARD WHERE QBOARD_NO = #{qboardNo}	
		</if>
		
		<if test="fboardNo != null">
			DELETE FROM FREE_BOARD WHERE FBOARD_NO = #{fboardNo}			
		</if>
	</delete>
	
	
	<select id="getComment" parameterType="board" resultType="boardComment">
		<if test="qboardNo != null">
			SELECT * FROM QUESTION_ANSWER WHERE BOARD_NO = #{qboardNo} ORDER BY COMMENT_REGDATE
		</if>
		
		<if test="fboardNo != null">
			SELECT * FROM BOARD_COMMENT WHERE BOARD_NO = #{fboardNo} ORDER BY COMMENT_REGDATE
		</if>	
	</select>
	
	<select id="getBoard" parameterType="board" resultType="board">
		<if test="qboardNo != null">
			SELECT * FROM QUESTION_BOARD WHERE QBOARD_NO = #{qboardNo} ORDER BY BOARD_REGDATE
		</if>
		
		<if test="fboardNo != null">
			SELECT * FROM FREE_BOARD WHERE FBOARD_NO = #{fboardNo} ORDER BY BOARD_REGDATE
		</if>	
	</select>
	
	
	<select id="getBoardList" parameterType="board" resultType="board">
		<if test="qboardNo != null">
			SELECT * FROM QUESTION_BOARD
		</if>
		
		<if test="qboardNo == null">
			SELECT * FROM FREE_BOARD
		</if>
		WHERE BOARD_TITLE LIKE '%'|| #{searchKeyword} ||'%'
		OR BOARD_CONTENT LIKE '%'|| #{searchKeyword} ||'%'
		ORDER BY BOARD_REGDATE DESC
	</select>
	
	<insert id="insertBoardReport" parameterType="boardReport">
	
		INSERT INTO BOARD_REPORT
		(REPORT_REASON,BOARD_TYPE,BOARD_NO,REPORTER,REPPERSON)
		VALUES 
		(#{reportReason}, #{boardType}, #{boardNo}, #{reporter}, #{repperson} )
	
	</insert>
	
	<select id="getBoardReport" parameterType="map" resultType="boardReport">
		SELECT * FROM BOARD_REPORT
		WHERE BOARD_TYPE = #{boardType}
		AND BOARD_NO = #{boardNo}
		AND REPORTER = #{userId}
	</select>
	
	<select id="getTopBoard" parameterType="board" resultType="board">
		SELECT * FROM
		    (SELECT * FROM QUESTION_BOARD
		    WHERE BOARD_REGDATE BETWEEN SYSDATE -7 AND SYSDATE
		    ORDER BY BOARD_HIT DESC)
		WHERE ROWNUM BETWEEN 1 AND 5
	</select>
	
	<insert id="addComment" parameterType="boardComment">
		<if test="qboardNo != null">
			INSERT INTO QUESTION_ANSWER
		</if>
		(COMMENT_NO, USER_ID, BOARD_NO, GRADE, COMMENT_CONTENT)
		VALUES ((SELECT NVL(MAX(COMMENT_NO),0) + 1 FROM QUESTION_ANSWER),
		#{userId}, #{boardNo}, #{grade}, #{commentContent})
	</insert>
	
	<delete id="delComment">
		<if test="section == 'qboard'">
			DELETE FROM QUESTION_ANSWER
		</if>
		WHERE COMMENT_NO = #{commentNo}
	</delete>
	
	<insert id="addCocomment" parameterType="boardComment">
		<if test="qboardNo != null">
			INSERT INTO QUESTION_ANSWER_COMMENT
		</if>
		(COMMENT2_NO, COMMENT_NO, USER_ID, GRADE, COMMENT2_CONTENT)
		VALUES ((SELECT NVL(MAX(COMMENT2_NO),0) + 1 FROM QUESTION_ANSWER_COMMENT),
		#{commentNo}, #{userId}, #{grade}, #{comment2Content})	
	</insert>
	
	<select id="getCocoment" parameterType="board" resultType="boardComment">
		SELECT * FROM (
		SELECT QAC.*, QA.BOARD_NO QBOARD_NO FROM QUESTION_ANSWER_COMMENT QAC, QUESTION_ANSWER QA
		WHERE QAC.COMMENT_NO = QA.COMMENT_NO
		ORDER BY COMMENT2_REGDATE ASC)
		WHERE QBOARD_NO = #{qboardNo}
	</select>
	
	<delete id="delCocomment" parameterType="boardComment">
		<if test="qboardNo != null">
			DELETE FROM QUESTION_ANSWER_COMMENT
		</if>
			WHERE COMMENT2_NO = #{comment2No}
	</delete>
	
	
</mapper>






